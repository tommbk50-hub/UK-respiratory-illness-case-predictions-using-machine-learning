<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Influenza Prediction Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Roboto', sans-serif; color: #333; }
        .dashboard-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); background: white; margin-bottom: 25px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .header-title { font-weight: 700; color: #1a202c; letter-spacing: -0.5px; }
        
        /* Diagram Styles */
        .diagram-container { display: flex; align-items: center; justify-content: center; gap: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px dashed #ced4da; }
        .step-box { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; width: 140px; text-align: center; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .step-box i { font-size: 1.5rem; color: #007bff; margin-bottom: 10px; display: block; }
        .arrow { font-size: 1.2rem; color: #adb5bd; }
        
        /* Metric Cards */
        .metric-value { font-size: 2.5rem; font-weight: 700; color: #2d3748; }
        .metric-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #718096; font-weight: 600; }
        
        .btn-download { background-color: #e2e8f0; color: #2d3748; border: none; font-weight: 500; }
        .btn-download:hover { background-color: #cbd5e0; color: #1a202c; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 fw-bold"><i class="fas fa-virus me-2"></i>UKHSA Influenza Forecast</span>
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-database me-1"></i> Data Source
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="https://ukhsa-dashboard.data.gov.uk/respiratory-viruses/influenza" target="_blank">Official UKHSA Dashboard</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Raw Data</h6></li>
                        <li><a class="dropdown-item" href="https://api.ukhsa-dashboard.data.gov.uk/themes/infectious_disease/sub_themes/respiratory/topics/Influenza/geography_types/Nation/geographies/England/metrics/influenza_testing_positivityByWeek?format=csv" target="_blank">Download CSV</a></li>
                        <li><a class="dropdown-item" href="https://api.ukhsa-dashboard.data.gov.uk/themes/infectious_disease/sub_themes/respiratory/topics/Influenza/geography_types/Nation/geographies/England/metrics/influenza_testing_positivityByWeek?format=json" target="_blank">Download JSON</a></li>
                    </ul>
                </div>
                <a href="https://github.com/tommbk50-hub/Data-Science-and-Anakytics-Projects" class="btn btn-light btn-sm fw-bold">GitHub</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <div class="row align-items-center mb-4">
            <div class="col-md-8">
                <h1 class="header-title">England Influenza Positivity</h1>
                <p class="text-muted mb-0">Forecast generated using <strong>HistGradientBoostingRegressor</strong> on weekly surveillance data.</p>
            </div>
            <div class="col-md-4 text-md-end">
                <span class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2 rounded-pill">
                    <i class="fas fa-check-circle me-1"></i> Model Active
                </span>
                <div class="text-muted small mt-2">Last Updated: <span id="last-updated" class="fw-bold">...</span></div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card p-4 text-center">
                    <div class="metric-value" id="latest-actual">--%</div>
                    <div class="metric-label">Current Positivity</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-4 text-center">
                    <div class="metric-value text-primary" id="next-week">--%</div>
                    <div class="metric-label">Forecast Next Week</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-4 text-center">
                    <div class="metric-value text-danger" id="peak-forecast">--%</div>
                    <div class="metric-label">Predicted Winter Peak</div>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0">Forecast vs Actuals</h5>
                <span class="badge bg-light text-dark border">Interactive Chart</span>
            </div>
            <div id="plot-div" style="width:100%; height:550px;"></div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card p-4">
                    <h4 class="fw-bold mb-4"><i class="fas fa-brain text-primary me-2"></i>How the Model Works</h4>
                    
                    <div class="row">
                        <div class="col-lg-6">
                            <p>We use the <strong>HistGradientBoostingRegressor</strong>, a modern machine learning algorithm optimized for speed and accuracy on large datasets. It works differently than traditional regression:</p>
                            
                            <ul class="list-group list-group-flush mb-4">
                                <li class="list-group-item bg-transparent"><i class="fas fa-bolt text-warning me-2"></i> <strong>Binning:</strong> Instead of sorting millions of numbers, it groups data into 255 "bins" (histograms). This makes it hundreds of times faster than standard Gradient Boosting.</li>
                                <li class="list-group-item bg-transparent"><i class="fas fa-layer-group text-info me-2"></i> <strong>Ensembling:</strong> It builds hundreds of small "decision trees." Each new tree calculates the error (residual) of the previous tree and tries to fix it.</li>
                                <li class="list-group-item bg-transparent"><i class="fas fa-chart-line text-success me-2"></i> <strong>Hybrid Approach:</strong> Our specific implementation first removes the annual seasonal trend (Baseline) and then uses the model to predict the specific deviations (Residuals) for this year.</li>
                            </ul>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="diagram-container h-100">
                                <div class="step-box">
                                    <i class="fas fa-database"></i>
                                    <strong>Raw Data</strong><br>
                                    <span class="text-muted small">Continuous Values</span>
                                </div>
                                <div class="arrow"><i class="fas fa-arrow-right"></i></div>
                                <div class="step-box">
                                    <i class="fas fa-th-large"></i>
                                    <strong>Binning</strong><br>
                                    <span class="text-muted small">Group into 255 Bins</span>
                                </div>
                                <div class="arrow"><i class="fas fa-arrow-right"></i></div>
                                <div class="step-box">
                                    <i class="fas fa-tree"></i>
                                    <strong>Tree Building</strong><br>
                                    <span class="text-muted small">Find Split Points</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        fetch('dashboard_data.json')
            .then(response => response.json())
            .then(data => {
                const history = data.history;
                const forecast = data.forecast;

                // 1. Seasonal Baseline (Faint Green)
                const traceBaseline = {
                    x: forecast.dates,
                    y: forecast.baseline,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Seasonal Norm',
                    line: { color: 'rgba(40, 167, 69, 0.4)', width: 2, dash: 'dot' },
                    hoverinfo: 'y'
                };

                // 2. The Forecast (Blue Dashed)
                const traceForecast = {
                    x: forecast.dates,
                    y: forecast.values,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Model Forecast',
                    line: { color: '#007bff', width: 3, dash: 'dash' }
                };

                // 3. Actual History (Thin Sharp Black Line)
                const traceHistory = {
                    x: history.dates,
                    y: history.values,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Actual Data',
                    line: { color: '#000000', width: 1.5 }, // Reduced width for sharper look
                    fill: 'tozeroy',
                    fillcolor: 'rgba(0, 0, 0, 0.05)'
                };

                // 4. Vertical "Today" Line
                const lastHistoryDate = history.dates[history.dates.length - 1];

                const layout = {
                    font: { family: 'Roboto, sans-serif' },
                    margin: { t: 30, b: 40, l: 60, r: 20 },
                    xaxis: { 
                        showgrid: true, 
                        gridcolor: '#e9ecef',
                        zeroline: false 
                    },
                    yaxis: { 
                        title: 'Positivity Rate (%)', 
                        showgrid: true, 
                        gridcolor: '#e9ecef',
                        zeroline: false
                    },
                    shapes: [{
                        type: 'line',
                        x0: lastHistoryDate,
                        y0: 0,
                        x1: lastHistoryDate,
                        y1: 1,
                        yref: 'paper',
                        line: { color: '#dc3545', width: 1.5, dash: 'dot' }
                    }],
                    annotations: [{
                        x: lastHistoryDate,
                        y: 1,
                        yref: 'paper',
                        text: 'Forecast Starts',
                        showarrow: false,
                        xanchor: 'left',
                        xshift: 5,
                        font: { color: '#dc3545', size: 12 }
                    }],
                    hovermode: 'x unified',
                    showlegend: true,
                    legend: { orientation: 'h', y: 1.05 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot('plot-div', [traceBaseline, traceForecast, traceHistory], layout);

                // Update Metrics
                const latestVal = history.values[history.values.length - 1];
                const maxForecast = Math.max(...forecast.values);
                const nextVal = forecast.values[0];

                document.getElementById('latest-actual').innerText = latestVal ? latestVal.toFixed(1) + '%' : 'N/A';
                document.getElementById('peak-forecast').innerText = maxForecast.toFixed(1) + '%';
                document.getElementById('next-week').innerText = nextVal.toFixed(1) + '%';
                
                document.getElementById('last-updated').innerText = new Date().toLocaleDateString();
            })
            .catch(err => console.error("Error:", err));
    </script>
</body>
</html>
