<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respiratory Virus Forecast</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Roboto', sans-serif; color: #333; }
        .dashboard-container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); background: white; margin-bottom: 30px; }
        .header-title { font-weight: 700; color: #1a202c; letter-spacing: -0.5px; }
        
        /* INCREASED HEIGHT FOR BETTER VISIBILITY */
        .chart-container { height: 500px; width: 100%; }
        .accuracy-container { height: 350px; width: 100%; }
        
        .metric-card-header { background: #fff; border-bottom: 1px solid #eee; padding: 15px 20px; border-radius: 12px 12px 0 0; }
        .metric-title { font-size: 1.25rem; font-weight: 700; color: #2c3e50; margin: 0; }
        
        .section-header { border-left: 5px solid #007bff; padding-left: 15px; margin: 50px 0 25px 0; color: #1a202c; font-size: 1.75rem; }
        .covid-header { border-left-color: #6610f2; }
        .accuracy-header { border-left-color: #198754; }
        
        .description-text { font-size: 1rem; line-height: 1.6; color: #495057; }
        .description-text a { text-decoration: none; font-weight: 500; }
        
        /* Tech Section Styles */
        .tech-section h5 { font-weight: 700; color: #2c3e50; margin-top: 30px; margin-bottom: 15px; }
        .math-block { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; margin: 15px 0; overflow-x: auto; }
        
        /* Code Block Styles */
        pre { background: #272822; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.9rem; }
        code { font-family: 'Consolas', 'Monaco', monospace; }
        .code-comment { color: #75715e; }
        .code-keyword { color: #66d9ef; }
        .code-string { color: #e6db74; }
        
        .loading-msg { display: flex; align-items: center; justify-content: center; height: 100%; color: #adb5bd; font-style: italic; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 fw-bold"><i class="fas fa-lungs-virus me-2"></i>UKHSA Respiratory Forecast</span>
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-database me-1"></i> Data Options
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="https://ukhsa-dashboard.data.gov.uk/" target="_blank">Official UKHSA Dashboard</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="https://github.com/tommbk50-hub/UK-respiratory-illness-case-predictions-using-machine-learning/blob/main/process_data.py" target="_blank"><i class="fas fa-code me-2 text-muted"></i>View Python Code</a></li>
                    </ul>
                </div>
                <a href="https://github.com/tommbk50-hub/UK-respiratory-illness-case-predictions-using-machine-learning" class="btn btn-light btn-sm fw-bold">GitHub</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <div class="row mb-4">
            <div class="col-lg-10">
                <h1 class="header-title mb-3">England Respiratory Virus Forecast Dashboard</h1>
                <p class="mb-3 text-muted">
                    By <a href="https://www.linkedin.com/in/tom-knight-340784151/" target="_blank" class="text-decoration-none fw-bold" style="color: #0077b5;"><i class="fab fa-linkedin me-1"></i>Tom Knight</a>
                </p>

                <div class="description-text">
                    <p>
                        This dashboard provides a comprehensive 52-week forecast for <strong>Influenza (Flu)</strong> and <strong>COVID-19</strong> in England. By analysing trends in PCR Positivity and Hospital Admissions, these models aim to support healthcare resource planningâ€”helping hospitals and A&E departments anticipate potential winter surges.
                    </p>
                    <p>
                        The predictions are generated using a <strong>Hybrid Machine Learning strategy</strong> (<a href="https://scikit-learn.org/stable/modules/ensemble.html#histogram-based-gradient-boosting" target="_blank">HistGradientBoostingRegressor</a>). The system is fully automated: it retrieves live data directly from the UKHSA public API and retrains all models every week via GitHub Actions.
                    </p>
                    <p class="text-muted small mt-3">
                        <i class="fas fa-info-circle me-1"></i> Data represents specimen dates (date of sample collection). Last updated: <span id="last-updated" class="fw-bold">...</span>.
                    </p>
                </div>
            </div>
        </div>

        <h3 class="section-header"><i class="fas fa-virus me-2 text-primary"></i>Influenza (Flu) Forecast</h3>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="metric-card-header"><h5 class="metric-title">PCR Positivity Rate</h5></div>
                    <div class="card-body"><div id="chart-positivity" class="chart-container"></div></div>
                </div>
            </div>
            <div class="col-12">
                <div class="card">
                    <div class="metric-card-header"><h5 class="metric-title">Hospital Admissions</h5></div>
                    <div class="card-body"><div id="chart-hospital" class="chart-container"></div></div>
                </div>
            </div>
            <div class="col-12">
                <div class="card">
                    <div class="metric-card-header"><h5 class="metric-title">ICU / HDU Admissions</h5></div>
                    <div class="card-body"><div id="chart-icu" class="chart-container"></div></div>
                </div>
            </div>
        </div>

        <h3 class="section-header covid-header"><i class="fas fa-lungs-virus me-2" style="color: #6610f2;"></i>COVID-19 Forecast</h3>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="metric-card-header"><h5 class="metric-title">PCR Positivity Rate</h5></div>
                    <div class="card-body"><div id="chart-covid-positivity" class="chart-container"></div></div>
                </div>
            </div>
            <div class="col-12">
                <div class="card">
                    <div class="metric-card-header"><h5 class="metric-title">Weekly Hospital Admissions</h5></div>
                    <div class="card-body"><div id="chart-covid-hospital" class="chart-container"></div></div>
                </div>
            </div>
        </div>

        <h3 class="section-header accuracy-header"><i class="fas fa-bullseye me-2 text-success"></i>Model Accuracy (Historical Backtest)</h3>
        <div class="row">
            <div class="col-12">
                <div class="card p-4">
                    <p class="small text-muted mb-2">
                        We continuously monitor performance by running a <strong>52-Week Rolling Backtest</strong>. This simulates how the model would have performed every week for the past year using only data available at that time.
                    </p>
                    <p class="small text-muted mb-2">
                        This chart is designed to be a "truth test." It displays two lines covering the past 52 weeks:
                    </p>
                    <ul class="small text-muted mb-3">
                        <li><strong>Solid Black Line (Actuals):</strong> The real number of hospital admissions reported by the UKHSA.</li>
                        <li><strong>Dotted Green Line (Model Prediction):</strong> What the model would have predicted for that week if it traveled back in time, using only the data available back then.</li>
                    </ul>
                    <p class="small text-muted mb-0">
                        When the Green line tracks closely with the Black line, it proves the model understands the patterns. If they diverge significantly (e.g., during a sudden outbreak), it visualizes the "Error Gap."
                    </p>
                    <div id="chart-accuracy" class="accuracy-container"></div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <div class="card p-5 tech-section">
                    <h4 class="fw-bold text-primary mb-4"><i class="fas fa-cogs me-2"></i>Technical Methodology</h4>
                    
                    <p>Our forecasting engine utilises a <strong>Hybrid Approach</strong>. We first isolate the predictable seasonal cycle, and then use Scikit-Learn's <code>HistGradientBoostingRegressor</code> to model the residuals (the difference between the seasonal baseline and reality).</p>

                    <hr class="my-4">

                    <h5>1. Histogram-Based Gradient Boosting (HGBR)</h5>
                    <p>
                        Histogram-Based Gradient Boosting is a sophisticated supervised machine learning algorithm designed to solve complex regression problems efficiently. It is an optimised evolution of traditional Gradient Boosting that groups continuous data into discrete 'bins' (histograms) rather than analysing every individual data point. This binning process significantly accelerates the training phase, making the model exceptionally capable of handling large-scale datasets without sacrificing accuracy.
                    </p>
                    <p>
                        <strong>Uncertainty Quantification:</strong> To provide 90% prediction intervals (the shaded cones in the charts above), we train the model three times using Quantile Loss functions. We model the median (0.5), the lower bound (0.05), and the upper bound (0.95), allowing us to quantify the range of likely outcomes rather than relying on a single point estimate.
                    </p>
                    
                    <div class="row">
                        <div class="col-lg-6">
                            <h6><strong>Step A: Data Discretisation (Binning)</strong></h6>
                            <p>Standard decision trees sort the feature values at every node split, which has a complexity of \(O(N \log N)\). HGBR instead discretises the continuous input features into integer-valued bins (max 255 bins).</p>
                            <div class="math-block">
                                $$ X_{binned} = \text{digitize}(X, \text{bins}) \in \{0, \dots, 255\} $$
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <h6><strong>Step B: The Additive Model</strong></h6>
                            <p>The model is an ensemble of \(M\) decision trees. It is an additive model where the prediction at step \(m\), denoted as \(F_m(x)\), is the sum of the previous prediction and a new tree \(h_m(x)\).</p>
                            <div class="math-block">
                                $$ F_m(x) = F_{m-1}(x) + \nu \cdot h_m(x) $$
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><strong>Step C: Gradient Descent Optimisation</strong></h6>
                            <p>
                                At each iteration \(m\), the new tree \(h_m(x)\) is trained to predict the <strong>negative gradient</strong> of the loss function. For our Least Squares loss function, this is the residual:
                            </p>
                            <div class="math-block text-center">
                                $$ r_i = - \frac{\partial L(y_i, F_{m-1}(x_i))}{\partial F_{m-1}(x_i)} = y_i - F_{m-1}(x_i) $$
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5>2. Python Implementation</h5>
                    <p>Below are core snippets from the <code>process_data.py</code> script that powers this dashboard. This script is automated via GitHub Actions to fetch data, train models, and generate the JSON payload used by the charts above.</p>

                    <h6 class="mt-4"><strong>A. Dynamic Configuration & API Strategy</strong></h6>
                    <p>We use a configuration dictionary to map simple keys (e.g., 'covid_hospital') to specific API parameters. This allows the script to handle different aggregation methods ('mean' vs 'sum') depending on whether the metric is a rate or a count.</p>
<pre><code>METRICS = {
    <span class="code-comment"># --- INFLUENZA ---</span>
    "positivity": {
        "topic": "Influenza",
        "metric_id": "influenza_testing_positivityByWeek",
        "agg": "mean" 
    },
    <span class="code-comment"># --- COVID-19 ---</span>
    "covid_hospital": {
        "topic": "COVID-19",
        "metric_id": "COVID-19_healthcare_admissionByDay", 
        "agg": "sum" <span class="code-comment"># Sum daily counts to get weekly total</span>
    }
}</code></pre>

                    <h6 class="mt-4"><strong>B. Data Fetching & Deduplication</strong></h6>
                    <p>The UKHSA API often returns multiple rows for a single date (e.g., regional breakdowns or age groups). The script automatically groups these by date and resamples them into clean weekly intervals (Ending Sunday) to ensure consistent time-series inputs for the ML model.</p>
<pre><code><span class="code-keyword">def</span> fetch_data(config):
    <span class="code-comment"># ... (Pagination Loop to fetch all pages) ...</span>

    <span class="code-comment"># CRITICAL: Group by date to merge duplicates</span>
    <span class="code-keyword">if</span> config['agg'] == 'sum':
        df = df.groupby('date')['metric_value'].sum().reset_index()
    <span class="code-keyword">else</span>:
        df = df.groupby('date')['metric_value'].mean().reset_index()

    <span class="code-comment"># Resample Daily data -> Weekly (W-SUN)</span>
    <span class="code-keyword">if</span> config['agg'] == 'sum':
        df = df.resample('W-SUN')['metric_value'].sum().to_frame()
    <span class="code-keyword">else</span>:
        df = df.resample('W-SUN')['metric_value'].mean().to_frame()
    
    <span class="code-keyword">return</span> df</code></pre>

                    <h6 class="mt-4"><strong>C. Hybrid Training with Quantile Regression (Intervals)</strong></h6>
                    <p>We train three versions of the model: one for the mean forecast, and two for the 5th and 95th percentiles (using Quantile Loss) to generate the prediction intervals.</p>
<pre><code><span class="code-keyword">def</span> train_and_forecast(df):
    <span class="code-comment"># 1. Main Forecast (Squared Error)</span>
    model_resid = HistGradientBoostingRegressor(loss='squared_error')
    model_resid.fit(X_train, y_train)

    <span class="code-comment"># 2. Upper Bound (95th Percentile)</span>
    model_upper = HistGradientBoostingRegressor(loss='quantile', quantile=0.95)
    model_upper.fit(X_train, y_train)

    <span class="code-comment"># 3. Lower Bound (5th Percentile)</span>
    model_lower = HistGradientBoostingRegressor(loss='quantile', quantile=0.05)
    model_lower.fit(X_train, y_train)</code></pre>

                    <hr class="my-4">

                    <div class="alert alert-light border">
                        <strong>Source References & Further Reading:</strong> 
                        <ul class="mb-0 mt-2 small">
                            <li class="mb-1"><a href="https://scikit-learn.org/stable/modules/ensemble.html#histogram-based-gradient-boosting" target="_blank">Scikit-Learn User Guide: Histogram-Based Gradient Boosting</a></li>
                            <li class="mb-1"><a href="https://machinelearningmastery.com/histogram-based-gradient-boosting-ensembles/" target="_blank">Machine Learning Mastery: Histogram-Based Gradient Boosting Ensembles</a></li>
                            <li class="mb-1"><a href="https://api.ukhsa-dashboard.data.gov.uk/themes/infectious_disease/sub_themes/respiratory/topics/Influenza/geography_types/Nation/geographies/England/metrics/influenza_testing_positivityByWeek" target="_blank">UKHSA API Documentation (JSON Endpoint)</a></li>
                            <li><a href="https://github.com/tommbk50-hub/UK-respiratory-illness-case-predictions-using-machine-learning" target="_blank">GitHub Repository: Full Python Source Code</a></li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Helper to convert hex to rgba for shading
        function hexToRgba(hex, alpha) {
            let c;
            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                c= hex.substring(1).split('');
                if(c.length== 3){
                    c= [c[0], c[0], c[1], c[1], c[2], c[2]];
                }
                c= '0x'+c.join('');
                return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
            }
            return hex;
        }

        // CONFIGURATION FOR ALL 5 CHARTS
        const chartsConfig = [
            // --- INFLUENZA ---
            { key: 'positivity',       divId: 'chart-positivity',       color: '#007bff' }, // Blue
            { key: 'hospital',         divId: 'chart-hospital',         color: '#dc3545' }, // Red
            { key: 'icu',              divId: 'chart-icu',              color: '#ffc107' }, // Yellow
            
            // --- COVID-19 ---
            { key: 'covid_positivity', divId: 'chart-covid-positivity', color: '#6610f2' }, // Purple
            { key: 'covid_hospital',   divId: 'chart-covid-hospital',   color: '#e83e8c' }  // Pink
        ];

        fetch('dashboard_data.json')
            .then(response => response.json())
            .then(data => {
                
                document.getElementById('last-updated').innerText = new Date().toLocaleDateString('en-GB');

                // 1. RENDER MAIN FORECAST CHARTS
                chartsConfig.forEach(config => {
                    const metricData = data[config.key];
                    const divElement = document.getElementById(config.divId);

                    if (!metricData) {
                        divElement.innerHTML = `<div class="loading-msg"><i class="fas fa-sync fa-spin me-2"></i> Waiting for data update...</div>`;
                        return;
                    }

                    const history = metricData.history;
                    const forecast = metricData.forecast;

                    // Baseline (Seasonal Norm)
                    const traceBaseline = {
                        x: forecast.dates, y: forecast.baseline,
                        type: 'scatter', mode: 'lines', name: 'Seasonal Norm',
                        line: { color: 'rgba(128, 128, 128, 0.4)', width: 2, dash: 'dot' },
                        hoverinfo: 'y'
                    };

                    // PREDICTION INTERVALS (The "Cone")
                    // Upper Bound (Invisible line)
                    const traceUpper = {
                        x: forecast.dates,
                        y: forecast.upper,
                        type: 'scatter',
                        mode: 'lines',
                        line: { width: 0 },
                        showlegend: false,
                        hoverinfo: 'skip'
                    };

                    // Lower Bound (Fills up to the Upper Bound)
                    const traceLower = {
                        x: forecast.dates,
                        y: forecast.lower,
                        type: 'scatter',
                        mode: 'lines',
                        fill: 'tonexty', // Fill area between this trace and the previous one (Upper)
                        fillcolor: hexToRgba(config.color, 0.2), // 20% opacity
                        line: { width: 0 },
                        showlegend: false,
                        hoverinfo: 'skip'
                    };

                    // Main Forecast (Dashed Line)
                    const traceForecast = {
                        x: forecast.dates, y: forecast.values,
                        type: 'scatter', mode: 'lines', name: 'Forecast',
                        line: { color: config.color, width: 3, dash: 'dash' }
                    };

                    // History (Solid Line)
                    const traceHistory = {
                        x: history.dates, y: history.values,
                        type: 'scatter', mode: 'lines', name: 'Actuals',
                        line: { color: '#212529', width: 2 },
                        fill: 'tozeroy', fillcolor: 'rgba(33, 37, 41, 0.05)'
                    };
                    
                    const lastHistoryDate = history.dates[history.dates.length - 1];
                    const layout = {
                        font: { family: 'Roboto, sans-serif' },
                        margin: { t: 20, b: 40, l: 50, r: 20 },
                        xaxis: { showgrid: true, gridcolor: '#f1f3f5' },
                        yaxis: { showgrid: true, gridcolor: '#f1f3f5' },
                        shapes: [{
                            type: 'line',
                            x0: lastHistoryDate, y0: 0,
                            x1: lastHistoryDate, y1: 1,
                            yref: 'paper',
                            line: { color: '#dc3545', width: 1.5, dash: 'dot' }
                        }],
                        showlegend: true, legend: { orientation: 'h', y: 1.1 },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                    };

                    // Order matters: Upper -> Lower (fill) -> Baseline -> Forecast -> History
                    // Only plot intervals if data exists
                    const traces = [traceBaseline];
                    if(forecast.upper && forecast.lower) {
                        traces.push(traceUpper, traceLower);
                    }
                    traces.push(traceForecast, traceHistory);

                    Plotly.newPlot(config.divId, traces, layout);
                });

                // 2. RENDER ACCURACY CHART
                const accuracyData = data['hospital'].accuracy;
                if (accuracyData) {
                    const traceActuals = {
                        x: accuracyData.dates,
                        y: accuracyData.actuals,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Actual Reported',
                        line: { color: '#212529', width: 2 }
                    };

                    const tracePreds = {
                        x: accuracyData.dates,
                        y: accuracyData.predictions,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Model Prediction',
                        line: { color: '#198754', width: 2, dash: 'dot' }
                    };
                    
                    const layoutAcc = {
                        title: { 
                            text: `Backtest Accuracy: ${accuracyData.mape.toFixed(1)}% Error (Past 52 Weeks)`, 
                            font: { size: 16, color: '#198754' } 
                        },
                        font: { family: 'Roboto, sans-serif' },
                        margin: { t: 40, b: 40, l: 50, r: 20 },
                        xaxis: { title: 'Date' },
                        yaxis: { title: 'Admissions' },
                        showlegend: true,
                        legend: { orientation: 'h', y: 1.1 },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                    };
                    
                    Plotly.newPlot('chart-accuracy', [traceActuals, tracePreds], layoutAcc);
                }

            })
            .catch(err => {
                console.error("Error:", err);
                document.querySelector('.dashboard-container').innerHTML += 
                    `<div class="alert alert-danger">Error loading data.json. Ensure the Python script has run successfully.</div>`;
            });
    </script>
</body>
</html>
