<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respiratory Virus Forecast</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Roboto', sans-serif; color: #333; }
        .dashboard-container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); background: white; margin-bottom: 30px; }
        .header-title { font-weight: 700; color: #1a202c; letter-spacing: -0.5px; }
        
        .chart-container { height: 500px; width: 100%; }
        .accuracy-container { height: 350px; width: 100%; }
        
        .metric-card-header { background: #fff; border-bottom: 1px solid #eee; padding: 15px 20px; border-radius: 12px 12px 0 0; }
        .metric-title { font-size: 1.25rem; font-weight: 700; color: #2c3e50; margin: 0; }
        
        .section-header { border-left: 5px solid #007bff; padding-left: 15px; margin: 50px 0 25px 0; color: #1a202c; font-size: 1.75rem; }
        .covid-header { border-left-color: #6610f2; }
        .accuracy-header { border-left-color: #198754; }
        .importance-header { border-left-color: #fd7e14; }
        
        .description-text { font-size: 1rem; line-height: 1.6; color: #495057; }
        .description-text a { text-decoration: none; font-weight: 500; }
        
        /* Tech Section Styles */
        .tech-section h5 { font-weight: 700; color: #2c3e50; margin-top: 40px; margin-bottom: 15px; font-size: 1.3rem; }
        .tech-section h6 { font-weight: 700; color: #495057; margin-top: 20px; font-size: 1.1rem; }
        .math-block { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; margin: 15px 0; overflow-x: auto; }
        
        pre { background: #272822; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.9rem; }
        code { font-family: 'Consolas', 'Monaco', monospace; }
        .code-comment { color: #75715e; } .code-keyword { color: #66d9ef; } .code-string { color: #e6db74; }
        
        .loading-msg { display: flex; align-items: center; justify-content: center; height: 100%; color: #adb5bd; font-style: italic; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 fw-bold"><i class="fas fa-lungs-virus me-2"></i>UKHSA Respiratory Forecast</span>
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-database me-1"></i> Data Options
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="https://ukhsa-dashboard.data.gov.uk/" target="_blank">Official UKHSA Dashboard</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="https://github.com/tommbk50-hub/UK-respiratory-illness-case-predictions-using-machine-learning/blob/main/process_data.py" target="_blank"><i class="fas fa-code me-2 text-muted"></i>View Python Code</a></li>
                    </ul>
                </div>
                <a href="https://github.com/tommbk50-hub/UK-respiratory-illness-case-predictions-using-machine-learning" class="btn btn-light btn-sm fw-bold">GitHub</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <div class="row mb-4">
            <div class="col-lg-10">
                <h1 class="header-title mb-3">England Respiratory Virus Forecast Dashboard</h1>
                <p class="mb-3 text-muted">
                    By <a href="https://www.linkedin.com/in/tom-knight-340784151/" target="_blank" class="text-decoration-none fw-bold" style="color: #0077b5;"><i class="fab fa-linkedin me-1"></i>Tom Knight</a>
                </p>

                <div class="description-text">
                    <p>
                        This dashboard provides a comprehensive 52-week forecast for <strong>Influenza (Flu)</strong> and <strong>COVID-19</strong> in England. By analysing trends in PCR Positivity and Hospital Admissions, these models aim to support healthcare resource planning—helping hospitals and A&E departments anticipate potential winter surges.
                    </p>
                    <p>
                        The predictions are generated using a <strong>Hybrid Machine Learning strategy</strong> (<a href="https://scikit-learn.org/stable/modules/ensemble.html#histogram-based-gradient-boosting" target="_blank">HistGradientBoostingRegressor</a>). The system is fully automated: it retrieves live data directly from the UKHSA public API and retrains all models every week via GitHub Actions.
                    </p>
                    <p class="text-muted small mt-3">
                        <i class="fas fa-info-circle me-1"></i> Data represents specimen dates (date of sample collection). Last updated: <span id="last-updated" class="fw-bold">...</span>.
                    </p>
                </div>
            </div>
        </div>

        <h3 class="section-header"><i class="fas fa-virus me-2 text-primary"></i>Influenza (Flu) Forecast</h3>
        <div class="row">
            <div class="col-12"><div class="card"><div class="metric-card-header"><h5 class="metric-title">PCR Positivity Rate</h5></div><div class="card-body"><div id="chart-positivity" class="chart-container"></div></div></div></div>
            <div class="col-12"><div class="card"><div class="metric-card-header"><h5 class="metric-title">Hospital Admissions</h5></div><div class="card-body"><div id="chart-hospital" class="chart-container"></div></div></div></div>
            <div class="col-12"><div class="card"><div class="metric-card-header"><h5 class="metric-title">ICU / HDU Admissions</h5></div><div class="card-body"><div id="chart-icu" class="chart-container"></div></div></div></div>
        </div>

        <h3 class="section-header covid-header"><i class="fas fa-lungs-virus me-2" style="color: #6610f2;"></i>COVID-19 Forecast</h3>
        <div class="row">
            <div class="col-12"><div class="card"><div class="metric-card-header"><h5 class="metric-title">PCR Positivity Rate</h5></div><div class="card-body"><div id="chart-covid-positivity" class="chart-container"></div></div></div></div>
            <div class="col-12"><div class="card"><div class="metric-card-header"><h5 class="metric-title">Weekly Hospital Admissions</h5></div><div class="card-body"><div id="chart-covid-hospital" class="chart-container"></div></div></div></div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <h3 class="section-header accuracy-header mt-0"><i class="fas fa-bullseye me-2 text-success"></i>Model Accuracy</h3>
                <div class="card p-4 h-100">
                    <p class="small text-muted mb-2">
                        <strong>52-Week Rolling Backtest:</strong> This chart compares the model's past predictions (green dotted line) against actual reported data (black line).
                    </p>
                    <div id="chart-accuracy" class="accuracy-container"></div>
                </div>
            </div>

            <div class="col-lg-6">
                <h3 class="section-header importance-header mt-0"><i class="fas fa-lightbulb me-2 text-warning"></i>Explainable AI</h3>
                <div class="card p-4 h-100">
                    <p class="small text-muted mb-2">
                        <strong>Feature Importance:</strong> Which variables drive the model's decisions? We use Permutation Importance to score features. High scores indicate the model relies heavily on that data point.
                    </p>
                    <div id="chart-importance" class="accuracy-container">
                        <div class="loading-msg">Waiting for data update...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <div class="card p-5 tech-section">
                    <h4 class="fw-bold text-primary mb-4"><i class="fas fa-cogs me-2"></i>Technical Methodology</h4>
                    
                    <p>Our forecasting engine utilises a <strong>Hybrid Approach</strong>. We first isolate the predictable seasonal cycle, and then use Scikit-Learn's <code>HistGradientBoostingRegressor</code> to model the residuals (the difference between the seasonal baseline and reality).</p>

                    <hr class="my-4">

                    <h5>1. Histogram-Based Gradient Boosting (HGBR)</h5>
                    <p>
                        Histogram-Based Gradient Boosting is a sophisticated supervised machine learning algorithm designed to solve complex regression problems efficiently. It is an optimised evolution of traditional Gradient Boosting that groups continuous data into discrete 'bins' (histograms) rather than analysing every individual data point. This binning process significantly accelerates the training phase, making the model exceptionally capable of handling large-scale datasets without sacrificing accuracy.
                    </p>
                    <p>
                        When applied to forecasting future trends, such as predicting flu outbreaks, the model uses a technique often called a 'sliding window' to interpret time-series data. Rather than simply reading dates, it utilises historical figures—such as infection rates from previous weeks—as input features to predict future values. Its major advantage is the ability to combine these historical lag features with external variables, such as seasonal weather changes or school term dates. This holistic approach allows the model to anticipate future surges in cases based on complex combinations of past behaviours, enabling more proactive planning and resource allocation.
                    </p>
                    
                    <div class="row">
                        <div class="col-lg-6">
                            <h6><strong>Step A: Data Discretisation (Binning)</strong></h6>
                            <p>Standard decision trees sort the feature values at every node split, which has a complexity of \(O(N \log N)\). HGBR instead discretises the continuous input features into integer-valued bins (max 255 bins).</p>
                            <div class="math-block">
                                $$ X_{binned} = \text{digitize}(X, \text{bins}) \in \{0, \dots, 255\} $$
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <h6><strong>Step B: The Additive Model</strong></h6>
                            <p>The model is an ensemble of \(M\) decision trees. It is an additive model where the prediction at step \(m\), denoted as \(F_m(x)\), is the sum of the previous prediction and a new tree \(h_m(x)\).</p>
                            <div class="math-block">
                                $$ F_m(x) = F_{m-1}(x) + \nu \cdot h_m(x) $$
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><strong>Step C: Gradient Descent Optimisation</strong></h6>
                            <p>
                                At each iteration \(m\), the new tree \(h_m(x)\) is trained to predict the <strong>negative gradient</strong> of the loss function. For our Least Squares loss function, this is the residual:
                            </p>
                            <div class="math-block text-center">
                                $$ r_i = - \frac{\partial L(y_i, F_{m-1}(x_i))}{\partial F_{m-1}(x_i)} = y_i - F_{m-1}(x_i) $$
                            </div>
                        </div>
                    </div>

                    <h5 class="mt-5">2. Uncertainty Quantification</h5>
                    <p>
                        A single point forecast (the "mean") implies 100% certainty, which is scientifically inaccurate. To address this, we generate <strong>90% Prediction Intervals</strong> (the shaded cones). We train three separate instances of the model using different loss functions:
                    </p>
                    <ul>
                        <li><strong>Median (0.5):</strong> The most likely outcome.</li>
                        <li><strong>Lower Bound (0.05):</strong> The 5th percentile (optimistic scenario).</li>
                        <li><strong>Upper Bound (0.95):</strong> The 95th percentile (worst-case scenario).</li>
                    </ul>

                    <h5 class="mt-5">3. Explainable AI (Feature Importance)</h5>
                    <p>
                        To demystify the "Black Box" nature of machine learning, we employ a technique called **Permutation Importance**. This evaluates the significance of each input feature (e.g., "Last Week's Cases" vs. "Seasonal Month") by randomly shuffling its values and measuring the resulting drop in model accuracy.
                    </p>
                    <p>
                        If shuffling a specific feature causes the model's error to spike, that feature is considered highly important. This validates that the model is making decisions based on reactive trends (Lag features) rather than just guessing based on the time of year.
                    </p>

                    <hr class="my-4">

                    <h5>4. Python Implementation</h5>
                    <p>Below are core snippets from the <code>process_data.py</code> script.</p>

                    <h6 class="mt-4"><strong>A. Dynamic Configuration</strong></h6>
<pre><code>METRICS = {
    "positivity": { "topic": "Influenza", "metric_id": "influenza_testing_positivityByWeek" },
    "hospital": { "topic": "Influenza", "metric_id": "influenza_healthcare_hospitalAdmissionRateByWeek" }
}</code></pre>

                    <h6 class="mt-4"><strong>B. Generating Prediction Intervals (Quantile Regression)</strong></h6>
<pre><code><span class="code-keyword">def</span> train_and_forecast(df):
    <span class="code-comment"># 1. Main Forecast</span>
    model_resid = HistGradientBoostingRegressor(loss='squared_error')
    <span class="code-comment"># 2. Upper Bound (95th Percentile)</span>
    model_upper = HistGradientBoostingRegressor(loss='quantile', quantile=0.95)
    <span class="code-comment"># 3. Lower Bound (5th Percentile)</span>
    model_lower = HistGradientBoostingRegressor(loss='quantile', quantile=0.05)</code></pre>

                    <h6 class="mt-4"><strong>C. Explainable AI (Permutation Importance)</strong></h6>
                    <p>We use Scikit-Learn's inspection module to calculate importance scores on the hold-out residuals.</p>
<pre><code><span class="code-keyword">from</span> sklearn.inspection <span class="code-keyword">import</span> permutation_importance

<span class="code-comment"># Calculate importance on the Residual Model</span>
result = permutation_importance(
    model_resid, 
    X_train, 
    y_train, 
    n_repeats=10, 
    random_state=42
)

<span class="code-comment"># Sort features by their impact on model accuracy</span>
importance_scores = result.importances_mean</code></pre>

                    <hr class="my-4">
                    <div class="alert alert-light border">
                        <strong>Source References & Further Reading:</strong> 
                        <ul class="mb-0 mt-2 small">
                            <li><a href="https://scikit-learn.org/stable/modules/ensemble.html" target="_blank">Scikit-Learn User Guide: HGBR</a></li>
                            <li><a href="https://machinelearningmastery.com/histogram-based-gradient-boosting-ensembles/" target="_blank">Machine Learning Mastery: Gradient Boosting Ensembles</a></li>
                            <li><a href="https://api.ukhsa-dashboard.data.gov.uk/" target="_blank">UKHSA API Documentation</a></li>
                            <li><a href="https://github.com/tommbk50-hub/UK-respiratory-illness-case-predictions-using-machine-learning" target="_blank">GitHub Repository: Source Code</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function hexToRgba(hex, alpha) {
            let c;
            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                c= hex.substring(1).split('');
                if(c.length== 3){ c= [c[0], c[0], c[1], c[1], c[2], c[2]]; }
                c= '0x'+c.join('');
                return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
            }
            return hex;
        }

        const chartsConfig = [
            { key: 'positivity',       divId: 'chart-positivity',       color: '#007bff' },
            { key: 'hospital',         divId: 'chart-hospital',         color: '#dc3545' },
            { key: 'icu',              divId: 'chart-icu',              color: '#ffc107' },
            { key: 'covid_positivity', divId: 'chart-covid-positivity', color: '#6610f2' },
            { key: 'covid_hospital',   divId: 'chart-covid-hospital',   color: '#e83e8c' }
        ];

        fetch('dashboard_data.json')
            .then(response => response.json())
            .then(data => {
                document.getElementById('last-updated').innerText = new Date().toLocaleDateString('en-GB');

                // 1. RENDER MAIN CHARTS
                chartsConfig.forEach(config => {
                    const metricData = data[config.key];
                    const divElement = document.getElementById(config.divId);
                    if (!metricData) { divElement.innerHTML = `<div class="loading-msg">Waiting for data...</div>`; return; }

                    const history = metricData.history;
                    const forecast = metricData.forecast;

                    const traceBaseline = {
                        x: forecast.dates, y: forecast.baseline,
                        type: 'scatter', mode: 'lines', name: 'Seasonal Norm',
                        line: { color: 'rgba(128, 128, 128, 0.4)', width: 2, dash: 'dot' }, hoverinfo: 'y'
                    };
                    const traceUpper = { x: forecast.dates, y: forecast.upper, type: 'scatter', mode: 'lines', line: { width: 0 }, showlegend: false, hoverinfo: 'skip' };
                    const traceLower = {
                        x: forecast.dates, y: forecast.lower, type: 'scatter', mode: 'lines',
                        fill: 'tonexty', fillcolor: hexToRgba(config.color, 0.2),
                        line: { width: 0 }, showlegend: true, name: 'Confidence Cone (90%)', hoverinfo: 'skip'
                    };
                    const traceForecast = { x: forecast.dates, y: forecast.values, type: 'scatter', mode: 'lines', name: 'Forecast', line: { color: config.color, width: 3, dash: 'dash' } };
                    const traceHistory = { x: history.dates, y: history.values, type: 'scatter', mode: 'lines', name: 'Actuals', line: { color: '#212529', width: 2 } };
                    
                    const layout = {
                        font: { family: 'Roboto, sans-serif' },
                        margin: { t: 20, b: 40, l: 50, r: 20 },
                        xaxis: { showgrid: true, gridcolor: '#f1f3f5' },
                        yaxis: { showgrid: true, gridcolor: '#f1f3f5' },
                        shapes: [{ type: 'line', x0: history.dates[history.dates.length - 1], y0: 0, x1: history.dates[history.dates.length - 1], y1: 1, yref: 'paper', line: { color: '#dc3545', width: 1.5, dash: 'dot' } }],
                        showlegend: true, legend: { orientation: 'h', y: -0.2 },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                    };

                    const traces = [traceBaseline];
                    if(forecast.upper && forecast.lower) { traces.push(traceUpper, traceLower); }
                    traces.push(traceForecast, traceHistory);
                    Plotly.newPlot(config.divId, traces, layout);
                });

                // 2. RENDER ACCURACY CHART
                const accuracyData = data['hospital'].accuracy;
                if (accuracyData) {
                    const traceActuals = { x: accuracyData.dates, y: accuracyData.actuals, type: 'scatter', mode: 'lines', name: 'Actual Reported', line: { color: '#212529', width: 2 } };
                    const tracePreds = { x: accuracyData.dates, y: accuracyData.predictions, type: 'scatter', mode: 'lines', name: 'Model Prediction', line: { color: '#198754', width: 2, dash: 'dot' } };
                    
                    const layoutAcc = {
                        title: { text: `Backtest Accuracy: ${accuracyData.mape.toFixed(1)}% Error (Past 52 Weeks)`, font: { size: 14 } },
                        font: { family: 'Roboto, sans-serif' },
                        margin: { t: 40, b: 40, l: 50, r: 20 },
                        xaxis: { title: 'Date' }, yaxis: { title: 'Admissions' },
                        showlegend: true, legend: { orientation: 'h', y: -0.2 },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                    };
                    Plotly.newPlot('chart-accuracy', [traceActuals, tracePreds], layoutAcc);
                }

                // 3. RENDER IMPORTANCE CHART
                const importanceData = data['hospital'].importance;
                if (importanceData) {
                    const traceImp = {
                        y: importanceData.map(d => d.name), x: importanceData.map(d => d.score),
                        type: 'bar', orientation: 'h', marker: { color: '#fd7e14' }
                    };
                    const layoutImp = {
                        title: { text: "What Drives the Model?", font: { size: 14 } },
                        font: { family: 'Roboto, sans-serif' },
                        margin: { t: 40, b: 40, l: 150, r: 20 },
                        xaxis: { title: 'Relative Importance Score' }, yaxis: { automargin: true },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                    };
                    Plotly.newPlot('chart-importance', [traceImp], layoutImp);
                } else {
                    document.getElementById('chart-importance').innerHTML = `<div class="loading-msg text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Data missing. Please re-run GitHub Action.</div>`;
                }

            })
            .catch(err => {
                console.error("Error:", err);
            });
    </script>
</body>
</html>
