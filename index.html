<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respiratory Virus Forecast</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Roboto', sans-serif; color: #333; }
        .dashboard-container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); background: white; margin-bottom: 25px; }
        .header-title { font-weight: 700; color: #1a202c; letter-spacing: -0.5px; }
        
        .chart-container { height: 400px; width: 100%; }
        .accuracy-container { height: 250px; width: 100%; }
        
        .metric-card-header { background: #fff; border-bottom: 1px solid #eee; padding: 15px 20px; border-radius: 12px 12px 0 0; }
        .metric-title { font-size: 1.1rem; font-weight: 700; color: #2c3e50; margin: 0; }
        
        .section-header { border-left: 5px solid #007bff; padding-left: 15px; margin: 40px 0 20px 0; color: #1a202c; }
        .covid-header { border-left-color: #6610f2; }
        .accuracy-header { border-left-color: #198754; }
        
        .description-text { font-size: 0.95rem; line-height: 1.6; color: #495057; }
        .description-text a { text-decoration: none; font-weight: 500; }
        
        /* Tech Section Styles */
        .tech-section h5 { font-weight: 700; color: #2c3e50; margin-top: 30px; margin-bottom: 15px; }
        .math-block { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; margin: 15px 0; overflow-x: auto; }
        
        /* Code Block Styles */
        pre { background: #272822; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.85rem; }
        code { font-family: 'Consolas', 'Monaco', monospace; }
        .code-comment { color: #75715e; }
        .code-keyword { color: #66d9ef; }
        .code-string { color: #e6db74; }
        
        .loading-msg { display: flex; align-items: center; justify-content: center; height: 100%; color: #adb5bd; font-style: italic; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 fw-bold"><i class="fas fa-lungs-virus me-2"></i>UKHSA Respiratory Forecast</span>
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-database me-1"></i> Data Options
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="https://ukhsa-dashboard.data.gov.uk/" target="_blank">Official UKHSA Dashboard</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="https://github.com/tommbk50-hub/UK-respiratory-illness-case-predictions-using-machine-learning/blob/main/process_data.py" target="_blank"><i class="fas fa-code me-2 text-muted"></i>View Python Code</a></li>
                    </ul>
                </div>
                <a href="https://github.com/tommbk50-hub/UK-respiratory-illness-case-predictions-using-machine-learning" class="btn btn-light btn-sm fw-bold">GitHub</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <div class="row mb-4">
            <div class="col-lg-9">
                <h1 class="header-title mb-2">England Respiratory Virus Forecast Dashboard</h1>
                <p class="mb-3 text-muted">
                    By <a href="https://www.linkedin.com/in/tom-knight-340784151/" target="_blank" class="text-decoration-none fw-bold" style="color: #0077b5;"><i class="fab fa-linkedin me-1"></i>Tom Knight</a>
                </p>

                <div class="description-text">
                    <p>
                        This dashboard provides a comprehensive 52-week forecast for <strong>Influenza (Flu)</strong> and <strong>COVID-19</strong> in England. By analysing trends in PCR Positivity and Hospital Admissions, these models aim to support healthcare resource planning—helping hospitals and A&E departments anticipate potential winter surges.
                    </p>
                    <p>
                        The predictions are generated using a <strong>Hybrid Machine Learning strategy</strong> (<a href="https://scikit-learn.org/stable/modules/ensemble.html#histogram-based-gradient-boosting" target="_blank">HistGradientBoostingRegressor</a>). The system is fully automated: it retrieves live data directly from the UKHSA public API and retrains all models every week via GitHub Actions.
                    </p>
                    <p class="text-muted small mt-3">
                        <i class="fas fa-info-circle me-1"></i> Data represents specimen dates (date of sample collection). Last updated: <span id="last-updated" class="fw-bold">...</span>.
                    </p>
                </div>
            </div>
        </div>

        <h3 class="section-header"><i class="fas fa-virus me-2 text-primary"></i>Influenza (Flu) Forecast</h3>
        <div class="row">
            <div class="col-lg-4">
                <div class="card">
                    <div class="metric-card-header"><h5 class="metric-title">PCR Positivity Rate</h5></div>
                    <div class="card-body"><div id="chart-positivity" class="chart-container"></div></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="metric-card-header"><h5 class="metric-title">Hospital Admissions</h5></div>
                    <div class="card-body"><div id="chart-hospital" class="chart-container"></div></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="metric-card-header"><h5 class="metric-title">ICU / HDU Admissions</h5></div>
                    <div class="card-body"><div id="chart-icu" class="chart-container"></div></div>
                </div>
            </div>
        </div>

        <h3 class="section-header covid-header"><i class="fas fa-lungs-virus me-2" style="color: #6610f2;"></i>COVID-19 Forecast</h3>
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="metric-card-header"><h5 class="metric-title">PCR Positivity Rate</h5></div>
                    <div class="card-body"><div id="chart-covid-positivity" class="chart-container"></div></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="metric-card-header"><h5 class="metric-title">Weekly Hospital Admissions</h5></div>
                    <div class="card-body"><div id="chart-covid-hospital" class="chart-container"></div></div>
                </div>
            </div>
        </div>

        <h3 class="section-header accuracy-header"><i class="fas fa-bullseye me-2 text-success"></i>Model Accuracy (Live Validation)</h3>
        <div class="row">
            <div class="col-lg-12">
                <div class="card p-4">
                    <p class="small text-muted mb-3">
                        Every week, the model performs a <strong>Walk-Forward Validation</strong> on the most recent 12 weeks of data. It re-trains on past data, predicts one week ahead, and compares the result to the actual reported value. The chart below shows the <strong>Absolute Error</strong> (Deviation) for the 'Flu Hospital Admissions' model over time.
                    </p>
                    <div id="chart-accuracy" class="accuracy-container"></div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card p-5 tech-section">
                    <h4 class="fw-bold text-primary mb-4"><i class="fas fa-cogs me-2"></i>Technical Methodology</h4>
                    
                    <p>Our forecasting engine utilises a <strong>Hybrid Approach</strong>. We first isolate the predictable seasonal cycle, and then use Scikit-Learn's <code>HistGradientBoostingRegressor</code> to model the residuals (the difference between the seasonal baseline and reality).</p>

                    <hr class="my-4">

                    <h5>1. Histogram-Based Gradient Boosting (HGBR)</h5>
                    <p>
                        Histogram-Based Gradient Boosting is a sophisticated supervised machine learning algorithm designed to solve complex regression problems efficiently. It is an optimised evolution of traditional Gradient Boosting that groups continuous data into discrete 'bins' (histograms) rather than analysing every individual data point. This binning process significantly accelerates the training phase, making the model exceptionally capable of handling large-scale datasets without sacrificing accuracy.
                    </p>
                    <p>
                        When applied to forecasting future trends, such as predicting flu outbreaks, the model uses a technique often called a 'sliding window' to interpret time-series data. Rather than simply reading dates, it utilises historical figures—such as infection rates from previous weeks—as input features to predict future values. Its major advantage is the ability to combine these historical lag features with external variables, such as seasonal weather changes or school term dates. This holistic approach allows the model to anticipate future surges in cases based on complex combinations of past behaviours, enabling more proactive planning and resource allocation.
                    </p>
                    <p>
                        The <code>HistGradientBoostingRegressor</code> is an implementation of Gradient Boosted Decision Trees (GBDT), inspired by LightGBM. It is significantly faster than traditional GBDT for large datasets because it uses <strong>histogram binning</strong>.
                    </p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6><strong>Step A: Data Discretisation (Binning)</strong></h6>
                            <p>Standard decision trees sort the feature values at every node split, which has a complexity of \(O(N \log N)\). HGBR instead discretises the continuous input features into integer-valued bins (max 255 bins).</p>
                            <div class="math-block">
                                $$ X_{binned} = \text{digitize}(X, \text{bins}) \in \{0, \dots, 255\} $$
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><strong>Step B: The Additive Model</strong></h6>
                            <p>The model is an ensemble of \(M\) decision trees. It is an additive model where the prediction at step \(m\), denoted as \(F_m(x)\), is the sum of the previous prediction and a new tree \(h_m(x)\).</p>
                            <div class="math-block">
                                $$ F_m(x) = F_{m-1}(x) + \nu \cdot h_m(x) $$
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><strong>Step C: Gradient Descent Optimisation</strong></h6>
                            <p>
                                At each iteration \(m\), the new tree \(h_m(x)\) is trained to predict the <strong>negative gradient</strong> of the loss function. For our Least Squares loss function, this is the residual:
                            </p>
                            <div class="math-block text-center">
                                $$ r_i = - \frac{\partial L(y_i, F_{m-1}(x_i))}{\partial F_{m-1}(x_i)} = y_i - F_{m-1}(x_i) $$
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5>2. Python Implementation</h5>
                    <p>Below are core snippets from the <code>process_data.py</code> script that powers this dashboard. This script is automated via GitHub Actions to fetch data, train models, and generate the JSON payload used by the charts above.</p>

                    <h6 class="mt-4"><strong>A. Dynamic Configuration & API Strategy</strong></h6>
                    <p>We use a configuration dictionary to map simple keys (e.g., 'covid_hospital') to specific API parameters. This allows the script to handle different aggregation methods ('mean' vs 'sum') depending on whether the metric is a rate or a count.</p>
<pre><code>METRICS = {
    <span class="code-comment"># --- INFLUENZA ---</span>
    "positivity": {
        "topic": "Influenza",
        "metric_id": "influenza_testing_positivityByWeek",
        "agg": "mean" 
    },
    <span class="code-comment"># --- COVID-19 ---</span>
    "covid_hospital": {
        "topic": "COVID-19",
        "metric_id": "COVID-19_healthcare_admissionByDay", 
        "agg": "sum" <span class="code-comment"># Sum daily counts to get weekly total</span>
    }
}</code></pre>

                    <h6 class="mt-4"><strong>B. Data Fetching & Deduplication</strong></h6>
                    <p>The UKHSA API often returns multiple rows for a single date (e.g., regional breakdowns or age groups). The script automatically groups these by date and resamples them into clean weekly intervals (Ending Sunday) to ensure consistent time-series inputs for the ML model.</p>
<pre><code><span class="code-keyword">def</span> fetch_data(config):
    <span class="code-comment"># ... (Pagination Loop to fetch all pages) ...</span>

    <span class="code-comment"># CRITICAL: Group by date to merge duplicates</span>
    <span class="code-keyword">if</span> config['agg'] == 'sum':
        df = df.groupby('date')['metric_value'].sum().reset_index()
    <span class="code-keyword">else</span>:
        df = df.groupby('date')['metric_value'].mean().reset_index()

    <span class="code-comment"># Resample Daily data -> Weekly (W-SUN)</span>
    <span class="code-keyword">if</span> config['agg'] == 'sum':
        df = df.resample('W-SUN')['metric_value'].sum().to_frame()
    <span class="code-keyword">else</span>:
        df = df.resample('W-SUN')['metric_value'].mean().to_frame()
    
    <span class="code-keyword">return</span> df</code></pre>

                    <h6 class="mt-4"><strong>C. Hybrid Training Logic</strong></h6>
                    <p>We train two separate models. First, a <strong>Seasonal Model</strong> learns the yearly pattern based on Week Number and Month. Second, a <strong>Residual Model</strong> learns to correct the errors of the first model by looking at recent trends (Lags).</p>
<pre><code><span class="code-keyword">def</span> train_and_forecast(df):
    <span class="code-comment"># 1. Train Seasonal Baseline</span>
    model_seasonal = HistGradientBoostingRegressor(categorical_features=[0, 1])
    model_seasonal.fit(df[['Week', 'Month']], df['metric_value'])
    
    <span class="code-comment"># Calculate Residuals (Real Value - Seasonal Prediction)</span>
    df['Residual'] = df['metric_value'] - df['Seasonal_Pred']

    <span class="code-comment"># 2. Train Residual Model (Using Lags)</span>
    model_resid = HistGradientBoostingRegressor()
    model_resid.fit(df[['Lag_1', 'Lag_2', 'Lag_3']], df['Residual'])</code></pre>

                    <h6 class="mt-4"><strong>D. Recursive Forecasting Loop</strong></h6>
                    <p>To predict 52 weeks out, we use a "sliding window" approach. The prediction for Week 1 becomes the historical input for Week 2, allowing the model to project trends far into the future.</p>
<pre><code>    history_residuals = df['Residual'].iloc[-3:].tolist()

    <span class="code-keyword">for</span> i <span class="code-keyword">in</span> range(52):
        <span class="code-comment"># Step 1: Predict standard seasonal baseline for this date</span>
        seasonal_base = model_seasonal.predict(future_date)
        
        <span class="code-comment"># Step 2: Predict deviation based on recent history</span>
        pred_residual = model_resid.predict([history_residuals[-3:]])
        
        <span class="code-comment"># Step 3: Combine</span>
        final_pred = seasonal_base + pred_residual

        <span class="code-comment"># Step 4: Feed prediction back into history for next loop</span>
        history_residuals.append(pred_residual)</code></pre>

                    <div class="alert alert-light border mt-4">
                        <strong>Source References:</strong> 
                        <ul class="mb-0 mt-2 small">
                            <li><a href="https://scikit-learn.org/stable/modules/ensemble.html#histogram-based-gradient-boosting" target="_blank">Scikit-Learn User Guide: Histogram-Based Gradient Boosting</a></li>
                            <li><a href="https://api.ukhsa-dashboard.data.gov.uk/themes/infectious_disease/sub_themes/respiratory/topics/Influenza/geography_types/Nation/geographies/England/metrics/influenza_testing_positivityByWeek" target="_blank">UKHSA API Endpoint (JSON)</a></li>
                            <li><a href="https://github.com/tommbk50-hub/UK-respiratory-illness-case-predictions-using-machine-learning/blob/main/process_data.py" target="_blank">View Python Source Code (GitHub)</a></li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // CONFIGURATION FOR ALL 5 CHARTS
        const chartsConfig = [
            // --- INFLUENZA ---
            { key: 'positivity',       divId: 'chart-positivity',       color: '#007bff' }, // Blue
            { key: 'hospital',         divId: 'chart-hospital',         color: '#dc3545' }, // Red
            { key: 'icu',              divId: 'chart-icu',              color: '#ffc107' }, // Yellow
            
            // --- COVID-19 ---
            { key: 'covid_positivity', divId: 'chart-covid-positivity', color: '#6610f2' }, // Purple
            { key: 'covid_hospital',   divId: 'chart-covid-hospital',   color: '#e83e8c' }  // Pink
        ];

        fetch('dashboard_data.json')
            .then(response => response.json())
            .then(data => {
                
                document.getElementById('last-updated').innerText = new Date().toLocaleDateString('en-GB');

                // 1. RENDER MAIN FORECAST CHARTS
                chartsConfig.forEach(config => {
                    const metricData = data[config.key];
                    const divElement = document.getElementById(config.divId);

                    if (!metricData) {
                        divElement.innerHTML = `<div class="loading-msg"><i class="fas fa-sync fa-spin me-2"></i> Waiting for data update...</div>`;
                        return;
                    }

                    const history = metricData.history;
                    const forecast = metricData.forecast;

                    const traceBaseline = {
                        x: forecast.dates, y: forecast.baseline,
                        type: 'scatter', mode: 'lines', name: 'Seasonal Norm',
                        line: { color: 'rgba(128, 128, 128, 0.4)', width: 2, dash: 'dot' },
                        hoverinfo: 'y'
                    };

                    const traceForecast = {
                        x: forecast.dates, y: forecast.values,
                        type: 'scatter', mode: 'lines', name: 'Forecast',
                        line: { color: config.color, width: 3, dash: 'dash' }
                    };

                    const traceHistory = {
                        x: history.dates, y: history.values,
                        type: 'scatter', mode: 'lines', name: 'Actuals',
                        line: { color: '#212529', width: 2 },
                        fill: 'tozeroy', fillcolor: 'rgba(33, 37, 41, 0.05)'
                    };
                    
                    const lastHistoryDate = history.dates[history.dates.length - 1];
                    const layout = {
                        font: { family: 'Roboto, sans-serif' },
                        margin: { t: 20, b: 40, l: 50, r: 20 },
                        xaxis: { showgrid: true, gridcolor: '#f1f3f5' },
                        yaxis: { showgrid: true, gridcolor: '#f1f3f5' },
                        shapes: [{
                            type: 'line',
                            x0: lastHistoryDate, y0: 0,
                            x1: lastHistoryDate, y1: 1,
                            yref: 'paper',
                            line: { color: '#dc3545', width: 1.5, dash: 'dot' }
                        }],
                        showlegend: true, legend: { orientation: 'h', y: 1.1 },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                    };

                    Plotly.newPlot(config.divId, [traceBaseline, traceForecast, traceHistory], layout);
                });

                // 2. RENDER ACCURACY CHART (Using Flu Hospital Data)
                const accuracyData = data['hospital'].accuracy;
                if (accuracyData) {
                    const errors = accuracyData.actuals.map((act, i) => Math.abs(act - accuracyData.predictions[i]));
                    
                    const traceError = {
                        x: accuracyData.dates,
                        y: errors,
                        type: 'bar',
                        name: 'Absolute Error',
                        marker: { color: '#198754' }
                    };
                    
                    const layoutAcc = {
                        title: { text: `MAE: ${accuracyData.mae.toFixed(2)} (Last 12 Weeks)`, font: { size: 14 } },
                        font: { family: 'Roboto, sans-serif' },
                        margin: { t: 30, b: 40, l: 50, r: 20 },
                        xaxis: { title: 'Validation Week' },
                        yaxis: { title: 'Prediction Error (Diff)' },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                    };
                    
                    Plotly.newPlot('chart-accuracy', [traceError], layoutAcc);
                }

            })
            .catch(err => {
                console.error("Error:", err);
                document.querySelector('.dashboard-container').innerHTML += 
                    `<div class="alert alert-danger">Error loading data.json. Ensure the Python script has run successfully.</div>`;
            });
    </script>
</body>
</html>
